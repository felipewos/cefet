<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Comunicado Escolar</title>
  <script>
    const senha = prompt("Digite a senha para acessar este site:");
    if (senha !== "unedpet") {
      alert("Senha incorreta!");
      window.location.href = "https://felipewos.github.io/cefet/";
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input, textarea { width: 100%; margin-bottom: 10px; padding: 5px; }
    #comunicado { padding: 40px; margin-top: 20px; line-height: 1.5; text-align: justify; }
  </style>
</head>
<body>

<h2>Gerar Comunicado</h2>

<label>Nome do aluno:</label>
<select id="aluno" onchange="preencherDados()">
  <option value="">-- Selecione --</option>
  <option value="Accacio Oliveira de Morais|3º ano|Telecomunicações">Accacio Oliveira de Morais</option>
  <option value="Alexandre Costa dos Santos Simões Sant'Ana|2º ano|Telecomunicações">Alexandre Costa dos Santos Simões Sant'Ana</option>
  <option value="Alice de Souza Cruz Filgueiras|1º ano B|Telecomunicações">Alice de Souza Cruz Filgueiras</option>
</select>

<label>Tipo de comunicado:</label>
<select id="tipo" onchange="ajustarInfracoesEObservacoes()">
  <option value="">-- Selecione --</option>
  <option value="Advertência">Advertência</option>
  <option value="Suspensão">Suspensão</option>
</select>

<label>Infração:</label>
<select id="infracao"></select>

<label>Observação:</label>
<textarea id="obs" rows="4" placeholder="Digite a observação aqui..."></textarea>

<label>Número do comunicado:</label>
<input type="number" id="numero">

<div id="suspensao_campos" style="display:none;">
  <label>Número de dias de suspensão:</label>
  <input type="number" id="dias_suspensao" value="6">

  <label>Data de retorno:</label>
  <input type="date" id="data_retorno">

  <label>Horário de retorno:</label>
  <input type="time" id="hora_retorno" value="11:00">
</div>

<button onclick="gerarComunicado()">Gerar Comunicado</button>
<button onclick="baixarPDF()">Salvar como PDF</button>
<div id="status" style="margin-top:10px; color: green; font-weight: bold;"></div>

<div id="comunicado" style="display:none">
  <h3 style="text-align: center;">Comunicado de <span class="tipo_out"></span> nº <span class="numero_out"></span>/<span id="ano_out"></span></h3>
  <p id="paragrafo_principal"></p>
  <p><em><span class="infracao_out"></span></em></p>
  <p>Observação: <span class="obs_out"></span></p>
  <p style="text-align: center;">Petrópolis, <span class="data_out"></span>.</p>
  <div style="text-align: center; margin-top: 60px;">
    <div style="border-bottom: 1px solid black; width: 300px; margin: 0 auto;"></div>
    <p style="margin-top: 5px;">Assinatura do Coordenador(a)</p>
  </div>

  <hr style="margin: 10px 0; border: 1px dashed black;">
  <div style="line-height: 1.5; font-size: 14px;">
    <p>Eu, ____________________________________, identidade nº ____________, órgão expedidor __________, responsável pelo(a) aluno(a) <strong><span class="nome_out"></span></strong>, declaro estar ciente do Comunicado de <span class="tipo_out"></span> nº <span class="numero_out"></span>/<span id="ano_out"></span>, emitido em <span class="data_out"></span>.</p>
    <p style="text-align: center;">Petrópolis, ____ de ____________ de <span id="ano_out"></span>.</p>
    <div style="text-align: center; margin-top: 40px;">
      <div style="border-bottom: 1px solid black; width: 300px; margin: 0 auto;"></div>
      <p style="margin-top: 5px;">Assinatura do responsável</p>
    </div>
  </div>

  <hr style="margin: 10px 0; border: 1px dashed black;">
  <div style="line-height: 1.5; font-size: 14px;">
    <p>Eu, <strong><span class="nome_out"></span></strong>, aluno(a) do <span class="turma_out"></span> do Curso Técnico em <span class="curso_out"></span> Integrado ao Ensino Médio, declaro estar ciente do Comunicado de <span class="tipo_out"></span> nº <span class="numero_out"></span>/<span id="ano_out"></span>, emitido em <span class="data_out"></span>. Comprometo-me a entregá-lo devidamente assinado pelo meu responsável no próximo dia letivo.</p>
    <p style="text-align: center;">Petrópolis, ____ de ____________ de <span id="ano_out"></span>.</p>
    <div style="text-align: center; margin-top: 40px;">
      <div style="border-bottom: 1px solid black; width: 300px; margin: 0 auto;"></div>
      <p style="margin-top: 5px;">Assinatura do aluno(a)</p>
    </div>
  </div>
</div>

<script>
// ... todas as funções anteriores como ajustarInfracoesEObservacoes(), preencherDados(), gerarComunicado() continuam ...

function baixarPDF() {
  const tipo = document.getElementById("tipo").value;
  const numero = document.getElementById("numero").value;
  const alunoSelecionado = document.getElementById("aluno").value;

  if (!tipo || !numero || !alunoSelecionado) {
    alert("Preencha todos os campos antes de salvar o PDF.");
    return;
  }

  const [nome] = alunoSelecionado.split("|");
  const tipoPrefix = tipo === "Advertência" ? "adv" : "sus";
  const nomeFormatado = nome.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "");
  const filename = `${tipoPrefix}${numero}_${nomeFormatado}.pdf`;
  const element = document.getElementById("comunicado");

  const status = document.getElementById("status");
  status.style.color = "green";
  status.textContent = "Enviando comunicado por e-mail... aguarde.";

  html2pdf().set({ margin: 1, filename: filename }).from(element).outputPdf('datauristring').then((pdfDataUri) => {
    const pdfBase64 = pdfDataUri.split(',')[1];

    const destinatarios = [
      "coordenacao@cefet-rj.br",
      "gerencia@cefet-rj.br",
      "saped@cefet-rj.br"
    ];

    fetch("https://comunicado-backend.onrender.com/enviar-comunicado", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nomeArquivo: filename,
        pdfBase64: pdfBase64,
        destinatario: destinatarios.join(",")
      })
    })
    .then(res => res.json())
    .then(data => {
      status.textContent = "Comunicado enviado por e-mail com sucesso!";
      status.style.color = "green";
    })
    .catch(err => {
      status.textContent = "Erro ao enviar e-mail: " + err.message;
      status.style.color = "red";
    });

    html2pdf().set({ margin: 1, filename: filename }).from(element).save();
  });
}
</script>

</body>
</html>
